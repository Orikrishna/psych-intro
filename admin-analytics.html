<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-xl);
        }

        .analytics-header {
            margin-bottom: var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .analytics-header h1 {
            color: var(--color-primary);
            margin: 0;
        }

        .refresh-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: inherit;
            font-size: var(--font-size-sm);
        }

        .refresh-btn:hover {
            background: var(--color-primary-dark);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
            border-bottom: 2px solid var(--color-bg-cream);
            padding-bottom: var(--space-sm);
        }

        .tab {
            background: none;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            font-family: inherit;
            font-size: var(--font-size-base);
            cursor: pointer;
            color: var(--color-text-secondary);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--color-bg-cream);
        }

        .tab.active {
            background: var(--color-primary);
            color: white;
            font-weight: var(--font-weight-semibold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-box {
            background: var(--color-bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .stat-box__value {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            display: block;
        }

        .stat-box__label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Analytics Section */
        .analytics-section {
            background: var(--color-bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
        }

        .analytics-section h2 {
            color: var(--color-primary-dark);
            margin-bottom: var(--space-lg);
            font-size: var(--font-size-xl);
            border-bottom: 2px solid var(--color-bg-mint);
            padding-bottom: var(--space-sm);
        }

        /* ApexCharts Container */
        #hourly-chart {
            width: 100%;
            height: 300px;
            direction: ltr;
        }

        .apexcharts-tooltip {
            direction: rtl;
            text-align: right;
        }

        .apexcharts-text {
            font-family: 'Heebo', sans-serif !important;
        }

        /* Tools Ranking */
        .tool-row {
            display: flex;
            align-items: center;
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-bg-cream);
        }

        .tool-row:last-child {
            border-bottom: none;
        }

        .tool-rank {
            font-weight: bold;
            color: var(--color-primary);
            width: 40px;
            font-size: var(--font-size-lg);
        }

        .tool-name {
            flex: 1;
            font-weight: var(--font-weight-medium);
        }

        .tool-count {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Events Table */
        .events-table {
            width: 100%;
            border-collapse: collapse;
        }

        .events-table th,
        .events-table td {
            padding: var(--space-md);
            text-align: right;
            border-bottom: 1px solid var(--color-bg-cream);
        }

        .events-table th {
            background: var(--color-bg-cream);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary-dark);
        }

        .events-table tr:hover {
            background: var(--color-bg-cream);
        }

        /* Score Badges */
        .score-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }

        .score-badge--high { background: #dcfce7; color: #16a34a; }
        .score-badge--medium { background: #fef3c7; color: #d97706; }
        .score-badge--low { background: #fee2e2; color: #dc2626; }

        /* Quiz Type Badge */
        .quiz-type-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        .quiz-type-badge--online { background: #dbeafe; color: #1d4ed8; }
        .quiz-type-badge--frontal { background: #f3e8ff; color: #7c3aed; }
        .quiz-type-badge--sample { background: #fce7f3; color: #be185d; }

        /* User Name */
        .user-name {
            font-weight: var(--font-weight-semibold);
        }

        .user-name-subtitle {
            font-weight: normal;
            color: var(--color-text-secondary);
            font-size: 0.85em;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: var(--space-xl);
            color: var(--color-text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl);
            color: var(--color-text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .analytics-container {
                padding: var(--space-md);
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1;
                min-width: 80px;
                text-align: center;
                padding: var(--space-sm);
            }

            .events-table {
                font-size: var(--font-size-sm);
            }

            .events-table th,
            .events-table td {
                padding: var(--space-sm);
            }
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <header class="analytics-header">
            <h1>  拽专</h1>
            <button class="refresh-btn" onclick="loadAllData()"> 专注</button>
        </header>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">住拽专</button>
            <button class="tab" data-tab="users">砖转砖</button>
            <button class="tab" data-tab="questions">砖转</button>
            <button class="tab" data-tab="activity">驻注转</button>
        </div>

        <!-- Tab 1: Overview -->
        <div class="tab-content active" id="overview-tab">
            <!-- Stats Row -->
            <div class="stats-overview">
                <div class="stat-box">
                    <span class="stat-box__value" id="total-users">-</span>
                    <span class="stat-box__label">砖转砖</span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="total-sessions">-</span>
                    <span class="stat-box__label">住砖</span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="avg-session-length">-</span>
                    <span class="stat-box__label">爪注 住砖 (拽壮)</span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="total-quizzes">-</span>
                    <span class="stat-box__label"></span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="avg-score">-</span>
                    <span class="stat-box__label">爪 爪注</span>
                </div>
            </div>

            <!-- Activity Over Time Graph -->
            <section class="analytics-section">
                <h2>驻注转 -36 砖注转 专转</h2>
                <div id="hourly-chart">
                    <div class="loading">注...</div>
                </div>
            </section>

            <!-- Top Tools -->
            <section class="analytics-section">
                <h2> 驻驻专</h2>
                <div id="tools-ranking">
                    <div class="loading">注...</div>
                </div>
            </section>
        </div>

        <!-- Tab 2: Users (Names List) -->
        <div class="tab-content" id="users-tab">
            <section class="analytics-section">
                <h2>专砖转 砖转砖</h2>
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>砖</th>
                            <th>转专 爪专驻转</th>
                            <th>驻注转 专</th>
                            <th></th>
                            <th>爪 爪注</th>
                        </tr>
                    </thead>
                    <tbody id="users-names-list">
                        <tr><td colspan="5" class="loading">注...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Tab 3: Questions (Difficult Questions) -->
        <div class="tab-content" id="questions-tab">
            <section class="analytics-section">
                <h2>砖转 拽砖转</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 16px;">砖转 注  砖  转专 ( 3 住转)</p>
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>砖</th>
                            <th>住</th>
                            <th>砖注专</th>
                            <th>住转</th>
                            <th> 砖</th>
                        </tr>
                    </thead>
                    <tbody id="difficult-questions-list">
                        <tr><td colspan="5" class="loading">注...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Tab 4: Recent Activity -->
        <div class="tab-content" id="activity-tab">
            <section class="analytics-section">
                <h2> 转爪转 </h2>
                <table class="events-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>砖转砖</th>
                            <th>住</th>
                            <th>砖注专</th>
                            <th>爪</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="scores-list">
                        <tr><td colspan="6" class="loading">注...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tbcgkmuucjxynibokxuo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2drbXV1Y2p4eW5pYm9reHVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMjQxODEsImV4cCI6MjA4NTcwMDE4MX0.oGYJoFlzIaFGehfC7gf0O0VK0y2_HJjISwQXUmUEbOU';

        // Excluded user IDs (admin/developer devices)
        let EXCLUDED_USER_IDS = [];

        // Generate fingerprint to detect current device
        function generateFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            const canvasData = canvas.toDataURL();
            const components = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                canvasData.slice(-50)
            ];
            let hash = 0;
            const str = components.join('|');
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'fp_' + Math.abs(hash).toString(36);
        }

        // Find and exclude current device's user ID
        async function initExcludedUsers() {
            const myFingerprint = generateFingerprint();
            console.log('My fingerprint:', myFingerprint);

            // Find user with this fingerprint
            const users = await supabaseGet(`users?device_fingerprint=eq.${myFingerprint}&select=id`);
            if (users.length > 0) {
                EXCLUDED_USER_IDS = users.map(u => u.id);
                console.log('Excluding user IDs:', EXCLUDED_USER_IDS);
            }
        }

        // Filter out excluded users
        function filterExcluded(items, userIdField = 'user_id') {
            if (EXCLUDED_USER_IDS.length === 0) return items;
            return items.filter(item => !EXCLUDED_USER_IDS.includes(item[userIdField]));
        }

        function filterExcludedUsers(users) {
            if (EXCLUDED_USER_IDS.length === 0) return users;
            return users.filter(u => !EXCLUDED_USER_IDS.includes(u.id));
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });

        async function supabaseGet(endpoint) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (!response.ok) {
                    console.warn('Supabase request failed:', response.status);
                    return [];
                }
                return response.json();
            } catch (e) {
                console.error('Supabase error:', e);
                return [];
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('he-IL', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getScoreBadgeClass(percentage) {
            if (percentage >= 70) return 'score-badge--high';
            if (percentage >= 50) return 'score-badge--medium';
            return 'score-badge--low';
        }

        function getQuizTypeLabel(type) {
            const labels = {
                'online': '拽',
                'frontal': '驻专',
                'sample': ''
            };
            return labels[type] || type || ' 注';
        }

        async function loadAllData() {
            // Load users (filtered)
            const allUsers = await supabaseGet('users?select=*&order=created_at.desc');
            const users = filterExcludedUsers(allUsers);
            document.getElementById('total-users').textContent = users.length;

            // Load sessions (filtered)
            const allSessions = await supabaseGet('sessions?select=*');
            const sessions = filterExcluded(allSessions);
            document.getElementById('total-sessions').textContent = sessions.length;

            // Calculate average session length
            let totalDuration = 0;
            let sessionsWithDuration = 0;
            sessions.forEach(s => {
                if (s.started_at && s.ended_at) {
                    const duration = (new Date(s.ended_at) - new Date(s.started_at)) / 1000 / 60;
                    if (duration > 0 && duration < 180) {
                        totalDuration += duration;
                        sessionsWithDuration++;
                    }
                }
            });
            const avgMinutes = sessionsWithDuration > 0 ? Math.round(totalDuration / sessionsWithDuration) : 0;
            document.getElementById('avg-session-length').textContent = avgMinutes;

            // Load ALL events (filtered)
            const rawEvents = await supabaseGet('events?select=*,users(animal_name,display_name)&order=created_at.desc');
            const allEvents = filterExcluded(rawEvents);

            // Quiz events
            const quizEvents = allEvents.filter(e => e.event_type === 'quiz_complete');
            document.getElementById('total-quizzes').textContent = quizEvents.length;

            // Average quiz score
            if (quizEvents.length > 0) {
                const avgScore = quizEvents.reduce((sum, e) => sum + (e.event_data?.percentage || 0), 0) / quizEvents.length;
                document.getElementById('avg-score').textContent = Math.round(avgScore) + '%';
            } else {
                document.getElementById('avg-score').textContent = '-';
            }

            // Hourly chart
            loadHourlyChart(allEvents);

            // Tools ranking
            loadToolsRanking(allEvents);

            // Users list
            loadUsersNamesList(users, allEvents);

            // Difficult questions
            loadDifficultQuestions();

            // Scores list
            loadScoresList(quizEvents);
        }

        let hourlyChart = null;

        function loadHourlyChart(events) {
            // Calculate 36 hours ago
            const now = new Date();
            const thirtySevenHoursAgo = new Date(now.getTime() - 37 * 60 * 60 * 1000);

            // Create hourly buckets for past 36 hours
            const hourlyData = [];
            for (let i = 36; i >= 0; i--) {
                const hourStart = new Date(now.getTime() - i * 60 * 60 * 1000);
                hourStart.setMinutes(0, 0, 0);
                hourlyData.push({
                    x: hourStart.getTime(),
                    y: 0
                });
            }

            // Count events per hour
            events.forEach(e => {
                const eventTime = new Date(e.created_at);
                if (eventTime >= thirtySevenHoursAgo) {
                    const eventHour = new Date(eventTime);
                    eventHour.setMinutes(0, 0, 0);
                    const hourTs = eventHour.getTime();

                    const bucket = hourlyData.find(d => d.x === hourTs);
                    if (bucket) {
                        bucket.y++;
                    }
                }
            });

            // Clear container
            const container = document.getElementById('hourly-chart');
            container.innerHTML = '';

            // Destroy existing chart if any
            if (hourlyChart) {
                hourlyChart.destroy();
            }

            // ApexCharts configuration
            const options = {
                series: [{
                    name: '驻注转',
                    data: hourlyData
                }],
                chart: {
                    type: 'bar',
                    height: 280,
                    fontFamily: 'Heebo, sans-serif',
                    toolbar: {
                        show: false
                    },
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800
                    }
                },
                colors: ['#4a9c6d'],
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '70%'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeUTC: false,
                        format: 'HH:mm',
                        style: {
                            fontSize: '11px',
                            fontFamily: 'Heebo, sans-serif'
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            fontSize: '11px',
                            fontFamily: 'Heebo, sans-serif'
                        },
                        formatter: function(val) {
                            return Math.round(val);
                        }
                    }
                },
                grid: {
                    borderColor: '#f1f1f1',
                    strokeDashArray: 4
                },
                tooltip: {
                    x: {
                        format: 'dd/MM HH:mm'
                    },
                    y: {
                        formatter: function(val) {
                            return val + ' 专注';
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'light',
                        type: 'vertical',
                        shadeIntensity: 0.5,
                        gradientToColors: ['#7bc89c'],
                        opacityFrom: 1,
                        opacityTo: 0.8
                    }
                }
            };

            hourlyChart = new ApexCharts(container, options);
            hourlyChart.render();
        }

        function loadToolsRanking(events) {
            const tools = {
                ' 拽': { clicks: 0, page: 'quiz.html' },
                ' 驻专': { clicks: 0, page: 'full-quiz.html' },
                ' ': { clicks: 0, page: 'sample-test.html' },
                '专住转': { clicks: 0, page: 'flashcards.html' },
                '住': { clicks: 0, page: 'summaries.html' },
                '砖注专 拽': { clicks: 0, page: 'online-lessons.html' },
                '砖注专 驻专': { clicks: 0, page: 'full-lessons.html' }
            };

            events.filter(e => e.event_type === 'page_view').forEach(e => {
                const page = e.event_data?.page;
                for (const [name, data] of Object.entries(tools)) {
                    if (page === data.page) data.clicks++;
                }
            });

            const sorted = Object.entries(tools)
                .sort((a, b) => b[1].clicks - a[1].clicks)
                .filter(([_, data]) => data.clicks > 0);

            if (sorted.length === 0) {
                document.getElementById('tools-ranking').innerHTML = '<div class="empty-state"> 转 注</div>';
                return;
            }

            document.getElementById('tools-ranking').innerHTML = sorted.map(([name, data], i) => `
                <div class="tool-row">
                    <span class="tool-rank">#${i + 1}</span>
                    <span class="tool-name">${name}</span>
                    <span class="tool-count">${data.clicks} 爪驻转</span>
                </div>
            `).join('');
        }

        function loadUsersNamesList(users, allEvents) {
            if (users.length === 0) {
                document.getElementById('users-names-list').innerHTML = '<tr><td colspan="5" class="empty-state"> 砖转砖 注</td></tr>';
                return;
            }

            // Get quiz counts and scores per user
            const userStats = {};
            allEvents.filter(e => e.event_type === 'quiz_complete').forEach(e => {
                if (!userStats[e.user_id]) {
                    userStats[e.user_id] = { quizCount: 0, totalScore: 0 };
                }
                userStats[e.user_id].quizCount++;
                userStats[e.user_id].totalScore += e.event_data?.percentage || 0;
            });

            // Get last activity per user
            const lastActivity = {};
            allEvents.forEach(e => {
                if (!lastActivity[e.user_id] || new Date(e.created_at) > new Date(lastActivity[e.user_id])) {
                    lastActivity[e.user_id] = e.created_at;
                }
            });

            document.getElementById('users-names-list').innerHTML = users.map(u => {
                const stats = userStats[u.id] || { quizCount: 0, totalScore: 0 };
                const avgScore = stats.quizCount > 0 ? Math.round(stats.totalScore / stats.quizCount) : '-';
                const displayName = u.display_name || u.animal_name;
                const subtitle = u.display_name ? `(${u.animal_name})` : '';

                return `
                    <tr>
                        <td><span class="user-name">${displayName}</span> <span class="user-name-subtitle">${subtitle}</span></td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>${lastActivity[u.id] ? formatDate(lastActivity[u.id]) : '-'}</td>
                        <td>${stats.quizCount}</td>
                        <td>${avgScore !== '-' ? `<span class="score-badge ${getScoreBadgeClass(avgScore)}">${avgScore}%</span>` : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadDifficultQuestions() {
            const rawAttempts = await supabaseGet('question_attempts?select=*');
            const attempts = filterExcluded(rawAttempts);

            if (attempts.length === 0) {
                document.getElementById('difficult-questions-list').innerHTML = '<tr><td colspan="5" class="empty-state"> 转 注 砖转 注</td></tr>';
                return;
            }

            // Group by question_id
            const stats = {};
            attempts.forEach(a => {
                if (!stats[a.question_id]) {
                    stats[a.question_id] = {
                        text: a.question_text,
                        lesson: a.lesson,
                        quizType: a.quiz_type,
                        total: 0,
                        wrong: 0
                    };
                }
                stats[a.question_id].total++;
                if (!a.is_correct) stats[a.question_id].wrong++;
            });

            // Sort by error rate, filter minimum attempts
            const hardest = Object.entries(stats)
                .map(([id, d]) => ({ id, ...d, errorRate: (d.wrong / d.total) * 100 }))
                .filter(q => q.total >= 3)
                .sort((a, b) => b.errorRate - a.errorRate)
                .slice(0, 20);

            if (hardest.length === 0) {
                document.getElementById('difficult-questions-list').innerHTML = '<tr><td colspan="5" class="empty-state">爪专 转专 转 ( 3 住转 砖)</td></tr>';
                return;
            }

            document.getElementById('difficult-questions-list').innerHTML = hardest.map(q => `
                <tr>
                    <td title="${q.text || ''}">${(q.text || 'N/A').substring(0, 50)}${(q.text || '').length > 50 ? '...' : ''}</td>
                    <td><span class="quiz-type-badge quiz-type-badge--${q.quizType || 'unknown'}">${getQuizTypeLabel(q.quizType)}</span></td>
                    <td>${q.lesson || '-'}</td>
                    <td>${q.total}</td>
                    <td><span class="score-badge ${q.errorRate > 50 ? 'score-badge--low' : 'score-badge--medium'}">${Math.round(q.errorRate)}%</span></td>
                </tr>
            `).join('');
        }

        function loadScoresList(quizEvents) {
            if (quizEvents.length === 0) {
                document.getElementById('scores-list').innerHTML = '<tr><td colspan="6" class="empty-state"> 转爪转  注</td></tr>';
                return;
            }

            document.getElementById('scores-list').innerHTML = quizEvents.map(event => {
                const data = event.event_data || {};
                const percentage = data.percentage || 0;
                const userName = event.users?.display_name || event.users?.animal_name || ' 注';

                return `
                    <tr>
                        <td>${formatDate(event.created_at)}</td>
                        <td><strong>${userName}</strong></td>
                        <td><span class="quiz-type-badge quiz-type-badge--${data.quiz_type || 'unknown'}">${getQuizTypeLabel(data.quiz_type)}</span></td>
                        <td>${data.lesson || '-'}</td>
                        <td>${data.score || 0}/${data.total || 0}</td>
                        <td><span class="score-badge ${getScoreBadgeClass(percentage)}">${percentage}%</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Load data on page load - first detect admin device, then load data
        (async function() {
            await initExcludedUsers();
            loadAllData();
        })();

        // Auto-refresh every 30 seconds
        setInterval(loadAllData, 30000);
    </script>
</body>
</html>
