<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-xl);
        }

        .analytics-header {
            margin-bottom: var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .analytics-header h1 {
            color: var(--color-primary);
            margin: 0;
        }

        .refresh-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: inherit;
            font-size: var(--font-size-sm);
        }

        .refresh-btn:hover {
            background: var(--color-primary-dark);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-xl);
            border-bottom: 2px solid var(--color-bg-cream);
            padding-bottom: var(--space-sm);
        }

        .tab {
            background: none;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            font-family: inherit;
            font-size: var(--font-size-base);
            cursor: pointer;
            color: var(--color-text-secondary);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--color-bg-cream);
        }

        .tab.active {
            background: var(--color-primary);
            color: white;
            font-weight: var(--font-weight-semibold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-box {
            background: var(--color-bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .stat-box__value {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            display: block;
        }

        .stat-box__label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Analytics Section */
        .analytics-section {
            background: var(--color-bg-card);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
        }

        .analytics-section h2 {
            color: var(--color-primary-dark);
            margin-bottom: var(--space-lg);
            font-size: var(--font-size-xl);
            border-bottom: 2px solid var(--color-bg-mint);
            padding-bottom: var(--space-sm);
        }

        /* ApexCharts Container */
        #daily-users-chart {
            width: 100%;
            height: 300px;
            direction: ltr;
        }

        .apexcharts-tooltip {
            direction: rtl;
            text-align: right;
        }

        .apexcharts-text {
            font-family: 'Heebo', sans-serif !important;
        }

        /* Tools Ranking */
        .tool-row {
            display: flex;
            align-items: center;
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-bg-cream);
        }

        .tool-row:last-child {
            border-bottom: none;
        }

        .tool-rank {
            font-weight: bold;
            color: var(--color-primary);
            width: 40px;
            font-size: var(--font-size-lg);
        }

        .tool-name {
            flex: 1;
            font-weight: var(--font-weight-medium);
        }

        .tool-count {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Events Table */
        .events-table {
            width: 100%;
            border-collapse: collapse;
        }

        .events-table th,
        .events-table td {
            padding: var(--space-md);
            text-align: right;
            border-bottom: 1px solid var(--color-bg-cream);
        }

        .events-table th {
            background: var(--color-bg-cream);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary-dark);
        }

        .events-table tr:hover {
            background: var(--color-bg-cream);
        }

        /* Score Badges */
        .score-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }

        .score-badge--high { background: #dcfce7; color: #16a34a; }
        .score-badge--medium { background: #fef3c7; color: #d97706; }
        .score-badge--low { background: #fee2e2; color: #dc2626; }

        /* Quiz Type Badge */
        .quiz-type-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        .quiz-type-badge--online { background: #dbeafe; color: #1d4ed8; }
        .quiz-type-badge--frontal { background: #f3e8ff; color: #7c3aed; }
        .quiz-type-badge--sample { background: #fce7f3; color: #be185d; }

        /* User Name */
        .user-name {
            font-weight: var(--font-weight-semibold);
        }

        .user-name-subtitle {
            font-weight: normal;
            color: var(--color-text-secondary);
            font-size: 0.85em;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: var(--space-xl);
            color: var(--color-text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl);
            color: var(--color-text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .analytics-container {
                padding: var(--space-md);
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1;
                min-width: 80px;
                text-align: center;
                padding: var(--space-sm);
            }

            .events-table {
                font-size: var(--font-size-sm);
            }

            .events-table th,
            .events-table td {
                padding: var(--space-sm);
            }
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <header class="analytics-header">
            <h1>ğŸ“Š ×œ×•×— ×‘×§×¨×”</h1>
            <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ ×¨×¢× ×Ÿ</button>
        </header>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">×¡×§×™×¨×”</button>
            <button class="tab" data-tab="users">××©×ª××©×™×</button>
            <button class="tab" data-tab="questions">×©××œ×•×ª</button>
            <button class="tab" data-tab="activity">×¤×¢×™×œ×•×ª</button>
        </div>

        <!-- Tab 1: Overview -->
        <div class="tab-content active" id="overview-tab">
            <!-- Stats Row -->
            <div class="stats-overview">
                <div class="stat-box">
                    <span class="stat-box__value" id="total-users">-</span>
                    <span class="stat-box__label">××©×ª××©×™×</span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="total-sessions">-</span>
                    <span class="stat-box__label">×¡×©× ×™×</span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="avg-session-length">-</span>
                    <span class="stat-box__label">×××•×¦×¢ ×¡×©×Ÿ (×“×§×³)</span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="total-quizzes">-</span>
                    <span class="stat-box__label">××‘×—× ×™×</span>
                </div>
                <div class="stat-box">
                    <span class="stat-box__value" id="avg-score">-</span>
                    <span class="stat-box__label">×¦×™×•×Ÿ ×××•×¦×¢</span>
                </div>
            </div>

            <!-- Activity Over Time Graph -->
            <section class="analytics-section">
                <h2>××©×ª××©×™× ×-1 ×‘×¤×‘×¨×•××¨</h2>
                <div id="daily-users-chart">
                    <div class="loading">×˜×•×¢×Ÿ...</div>
                </div>
            </section>

            <!-- Top Tools -->
            <section class="analytics-section">
                <h2>5 ×›×œ×™× ×”×›×™ ×¤×•×¤×•×œ×¨×™×™×</h2>
                <div id="tools-ranking">
                    <div class="loading">×˜×•×¢×Ÿ...</div>
                </div>
            </section>
        </div>

        <!-- Tab 2: Users (Names List) -->
        <div class="tab-content" id="users-tab">
            <section class="analytics-section">
                <h2>×¨×©×™××ª ××©×ª××©×™×</h2>
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>×©×</th>
                            <th>××›×©×™×¨</th>
                            <th>×ª××¨×™×š ×”×¦×˜×¨×¤×•×ª</th>
                            <th>×¤×¢×™×œ×•×ª ××—×¨×•× ×”</th>
                            <th>×¡×©× ×™×</th>
                            <th>×–××Ÿ ×œ×™××•×“</th>
                            <th>×××•×¦×¢ ×¡×©×Ÿ</th>
                            <th>×›×œ×™ ××”×•×‘</th>
                            <th>××‘×—× ×™×</th>
                            <th>×¦×™×•×Ÿ ×××•×¦×¢</th>
                        </tr>
                    </thead>
                    <tbody id="users-names-list">
                        <tr><td colspan="10" class="loading">×˜×•×¢×Ÿ...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Tab 3: Questions (Difficult Questions) -->
        <div class="tab-content" id="questions-tab">
            <section class="analytics-section">
                <h2>10 ×©××œ×•×ª ×‘××‘×—×Ÿ ×œ×“×•×’×× ×©×”×›×™ ×”×¨×‘×” ×ª×œ××™×“×™× ×˜×•×¢×™× ×‘×”×Ÿ</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 16px;">××™× ×™××•× 3 × ×™×¡×™×•× ×•×ª ×œ×›×œ ×©××œ×”</p>
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>×©××œ×”</th>
                            <th>×¡×•×’</th>
                            <th>×©×™×¢×•×¨</th>
                            <th>× ×™×¡×™×•× ×•×ª</th>
                            <th>××—×•×– ×©×’×™××”</th>
                        </tr>
                    </thead>
                    <tbody id="difficult-questions-list">
                        <tr><td colspan="5" class="loading">×˜×•×¢×Ÿ...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Tab 4: Recent Activity -->
        <div class="tab-content" id="activity-tab">
            <section class="analytics-section">
                <h2>×›×œ ×ª×•×¦××•×ª ×”××‘×—× ×™×</h2>
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>×–××Ÿ</th>
                            <th>××©×ª××©</th>
                            <th>×¡×•×’</th>
                            <th>×©×™×¢×•×¨</th>
                            <th>×¦×™×•×Ÿ</th>
                            <th>××—×•×–</th>
                        </tr>
                    </thead>
                    <tbody id="scores-list">
                        <tr><td colspan="6" class="loading">×˜×•×¢×Ÿ...</td></tr>
                    </tbody>
                </table>
            </section>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tbcgkmuucjxynibokxuo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiY2drbXV1Y2p4eW5pYm9reHVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMjQxODEsImV4cCI6MjA4NTcwMDE4MX0.oGYJoFlzIaFGehfC7gf0O0VK0y2_HJjISwQXUmUEbOU';

        // Excluded user IDs (admin/developer devices)
        let EXCLUDED_USER_IDS = [];

        // Generate fingerprint to detect current device
        function generateFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            const canvasData = canvas.toDataURL();
            const components = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                canvasData.slice(-50)
            ];
            let hash = 0;
            const str = components.join('|');
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'fp_' + Math.abs(hash).toString(36);
        }

        // Find and exclude current device's user ID
        async function initExcludedUsers() {
            const myFingerprint = generateFingerprint();
            console.log('My fingerprint:', myFingerprint);

            // Find user with this fingerprint
            const users = await supabaseGet(`users?device_fingerprint=eq.${myFingerprint}&select=id`);
            if (users.length > 0) {
                EXCLUDED_USER_IDS = users.map(u => u.id);
                console.log('Excluding user IDs:', EXCLUDED_USER_IDS);
            }
        }

        // Filter out excluded users
        function filterExcluded(items, userIdField = 'user_id') {
            if (EXCLUDED_USER_IDS.length === 0) return items;
            return items.filter(item => !EXCLUDED_USER_IDS.includes(item[userIdField]));
        }

        function filterExcludedUsers(users) {
            if (EXCLUDED_USER_IDS.length === 0) return users;
            return users.filter(u => !EXCLUDED_USER_IDS.includes(u.id));
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });

        async function supabaseGet(endpoint) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (!response.ok) {
                    console.warn('Supabase request failed:', response.status);
                    return [];
                }
                return response.json();
            } catch (e) {
                console.error('Supabase error:', e);
                return [];
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('he-IL', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getScoreBadgeClass(percentage) {
            if (percentage >= 70) return 'score-badge--high';
            if (percentage >= 50) return 'score-badge--medium';
            return 'score-badge--low';
        }

        function getQuizTypeLabel(type) {
            const labels = {
                'online': '××§×•×•×Ÿ',
                'frontal': '×¤×¨×•× ×˜×œ×™',
                'sample': '×œ×“×•×’××'
            };
            return labels[type] || type || '×œ× ×™×“×•×¢';
        }

        async function loadAllData() {
            // Load users (filtered)
            const allUsers = await supabaseGet('users?select=*&order=created_at.desc');
            const users = filterExcludedUsers(allUsers);
            document.getElementById('total-users').textContent = users.length;

            // Load sessions (filtered)
            const allSessions = await supabaseGet('sessions?select=*');
            const sessions = filterExcluded(allSessions);
            document.getElementById('total-sessions').textContent = sessions.length;

            // Calculate average session length
            let totalDuration = 0;
            let sessionsWithDuration = 0;
            sessions.forEach(s => {
                if (s.started_at && s.ended_at) {
                    const duration = (new Date(s.ended_at) - new Date(s.started_at)) / 1000 / 60;
                    if (duration > 0 && duration < 180) {
                        totalDuration += duration;
                        sessionsWithDuration++;
                    }
                }
            });
            const avgMinutes = sessionsWithDuration > 0 ? Math.round(totalDuration / sessionsWithDuration) : 0;
            document.getElementById('avg-session-length').textContent = avgMinutes;

            // Load ALL events (filtered)
            const rawEvents = await supabaseGet('events?select=*,users(animal_name,display_name)&order=created_at.desc');
            const allEvents = filterExcluded(rawEvents);

            // Quiz events
            const quizEvents = allEvents.filter(e => e.event_type === 'quiz_complete');
            document.getElementById('total-quizzes').textContent = quizEvents.length;

            // Average quiz score
            if (quizEvents.length > 0) {
                const avgScore = quizEvents.reduce((sum, e) => sum + (e.event_data?.percentage || 0), 0) / quizEvents.length;
                document.getElementById('avg-score').textContent = Math.round(avgScore) + '%';
            } else {
                document.getElementById('avg-score').textContent = '-';
            }

            // Daily users chart (since Feb 1)
            loadDailyUsersChart(users);

            // Tools ranking (top 5)
            loadToolsRanking(allEvents);

            // Users list
            loadUsersNamesList(users, sessions, allEvents);

            // Difficult questions (sample test only, top 10)
            loadDifficultQuestions();

            // Scores list
            loadScoresList(quizEvents);
        }

        let dailyUsersChart = null;

        function loadDailyUsersChart(users) {
            // Feb 1, 2026
            const startDate = new Date('2026-02-01T00:00:00');
            const now = new Date();

            // Create daily buckets from Feb 1 to today
            const dailyData = [];
            const currentDate = new Date(startDate);

            while (currentDate <= now) {
                dailyData.push({
                    x: currentDate.getTime(),
                    y: 0
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Count new users per day
            users.forEach(u => {
                const userDate = new Date(u.created_at);
                if (userDate >= startDate) {
                    const dayStart = new Date(userDate);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayTs = dayStart.getTime();

                    const bucket = dailyData.find(d => d.x === dayTs);
                    if (bucket) {
                        bucket.y++;
                    }
                }
            });

            // Clear container
            const container = document.getElementById('daily-users-chart');
            container.innerHTML = '';

            // Destroy existing chart if any
            if (dailyUsersChart) {
                dailyUsersChart.destroy();
            }

            // ApexCharts configuration
            const options = {
                series: [{
                    name: '××©×ª××©×™× ×—×“×©×™×',
                    data: dailyData
                }],
                chart: {
                    type: 'area',
                    height: 280,
                    fontFamily: 'Heebo, sans-serif',
                    toolbar: {
                        show: false
                    },
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 800
                    }
                },
                colors: ['#2d7d46'],
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeUTC: false,
                        format: 'dd/MM',
                        style: {
                            fontSize: '11px',
                            fontFamily: 'Heebo, sans-serif'
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            fontSize: '11px',
                            fontFamily: 'Heebo, sans-serif'
                        },
                        formatter: function(val) {
                            return Math.round(val);
                        }
                    }
                },
                grid: {
                    borderColor: '#f1f1f1',
                    strokeDashArray: 4
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    },
                    y: {
                        formatter: function(val) {
                            return val + ' ××©×ª××©×™×';
                        }
                    }
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'light',
                        type: 'vertical',
                        shadeIntensity: 0.3,
                        gradientToColors: ['#47c163'],
                        opacityFrom: 0.7,
                        opacityTo: 0.2
                    }
                }
            };

            dailyUsersChart = new ApexCharts(container, options);
            dailyUsersChart.render();
        }

        function loadToolsRanking(events) {
            const tools = {
                '××‘×—× ×™× ××§×•×•× ×™×': { clicks: 0, page: 'quiz.html' },
                '××‘×—× ×™× ×¤×¨×•× ×˜×œ×™×™×': { clicks: 0, page: 'full-quiz.html' },
                '××‘×—×Ÿ ×œ×“×•×’××': { clicks: 0, page: 'sample-test.html' },
                '×›×¨×˜×™×¡×™×•×ª': { clicks: 0, page: 'flashcards.html' },
                '×¡×™×›×•××™×': { clicks: 0, page: 'summaries.html' },
                '×©×™×¢×•×¨×™× ××§×•×•× ×™×': { clicks: 0, page: 'online-lessons.html' },
                '×©×™×¢×•×¨×™× ×¤×¨×•× ×˜×œ×™×™×': { clicks: 0, page: 'full-lessons.html' }
            };

            events.filter(e => e.event_type === 'page_view').forEach(e => {
                const page = e.event_data?.page;
                for (const [name, data] of Object.entries(tools)) {
                    if (page === data.page) data.clicks++;
                }
            });

            const sorted = Object.entries(tools)
                .sort((a, b) => b[1].clicks - a[1].clicks)
                .filter(([_, data]) => data.clicks > 0)
                .slice(0, 5); // Top 5

            if (sorted.length === 0) {
                document.getElementById('tools-ranking').innerHTML = '<div class="empty-state">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ</div>';
                return;
            }

            document.getElementById('tools-ranking').innerHTML = sorted.map(([name, data], i) => `
                <div class="tool-row">
                    <span class="tool-rank">#${i + 1}</span>
                    <span class="tool-name">${name}</span>
                    <span class="tool-count">${data.clicks} ×¦×¤×™×•×ª</span>
                </div>
            `).join('');
        }

        function loadUsersNamesList(users, sessions, allEvents) {
            if (users.length === 0) {
                document.getElementById('users-names-list').innerHTML = '<tr><td colspan="10" class="empty-state">××™×Ÿ ××©×ª××©×™× ×¢×“×™×™×Ÿ</td></tr>';
                return;
            }

            // Calculate session stats per user
            const sessionStats = {};
            sessions.forEach(s => {
                if (!sessionStats[s.user_id]) {
                    sessionStats[s.user_id] = { count: 0, totalDuration: 0 };
                }
                sessionStats[s.user_id].count++;

                // Calculate duration if session has start and end
                if (s.started_at && s.ended_at) {
                    const duration = (new Date(s.ended_at) - new Date(s.started_at)) / 1000 / 60; // minutes
                    if (duration > 0 && duration < 180) { // Ignore sessions > 3 hours
                        sessionStats[s.user_id].totalDuration += duration;
                    }
                }
            });

            // Get quiz counts and scores per user
            const userStats = {};
            allEvents.filter(e => e.event_type === 'quiz_complete').forEach(e => {
                if (!userStats[e.user_id]) {
                    userStats[e.user_id] = { quizCount: 0, totalScore: 0 };
                }
                userStats[e.user_id].quizCount++;
                userStats[e.user_id].totalScore += e.event_data?.percentage || 0;
            });

            // Get most used tool per user
            const toolUsage = {};
            const toolMap = {
                'quiz.html': '××‘×—× ×™× ××§×•×•× ×™×',
                'full-quiz.html': '××‘×—× ×™× ×¤×¨×•× ×˜×œ×™×™×',
                'sample-test.html': '××‘×—×Ÿ ×œ×“×•×’××',
                'flashcards.html': '×›×¨×˜×™×¡×™×•×ª',
                'summaries.html': '×¡×™×›×•××™×'
            };
            allEvents.filter(e => e.event_type === 'page_view').forEach(e => {
                const page = e.event_data?.page;
                if (toolMap[page]) {
                    if (!toolUsage[e.user_id]) {
                        toolUsage[e.user_id] = {};
                    }
                    toolUsage[e.user_id][page] = (toolUsage[e.user_id][page] || 0) + 1;
                }
            });

            // Get last activity per user
            const lastActivity = {};
            allEvents.forEach(e => {
                if (!lastActivity[e.user_id] || new Date(e.created_at) > new Date(lastActivity[e.user_id])) {
                    lastActivity[e.user_id] = e.created_at;
                }
            });

            document.getElementById('users-names-list').innerHTML = users.map(u => {
                const stats = userStats[u.id] || { quizCount: 0, totalScore: 0 };
                const avgScore = stats.quizCount > 0 ? Math.round(stats.totalScore / stats.quizCount) : '-';
                const displayName = u.display_name || u.animal_name;
                const subtitle = u.display_name ? `(${u.animal_name})` : '';
                const deviceIcon = getDeviceIcon(u.device_type);

                const sesStats = sessionStats[u.id] || { count: 0, totalDuration: 0 };
                const sessionCount = sesStats.count;
                const totalStudyTime = sesStats.totalDuration > 0 ? Math.round(sesStats.totalDuration) : 0;
                const avgSessionLength = sesStats.count > 0 && sesStats.totalDuration > 0
                    ? Math.round(sesStats.totalDuration / sesStats.count)
                    : 0;

                // Find most used tool
                let favTool = '-';
                if (toolUsage[u.id]) {
                    const sorted = Object.entries(toolUsage[u.id]).sort((a, b) => b[1] - a[1]);
                    if (sorted.length > 0) {
                        favTool = toolMap[sorted[0][0]];
                    }
                }

                return `
                    <tr>
                        <td><span class="user-name">${displayName}</span> <span class="user-name-subtitle">${subtitle}</span></td>
                        <td>${deviceIcon}</td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>${lastActivity[u.id] ? formatDate(lastActivity[u.id]) : '-'}</td>
                        <td>${sessionCount}</td>
                        <td>${totalStudyTime > 0 ? totalStudyTime + ' ×“×§×³' : '-'}</td>
                        <td>${avgSessionLength > 0 ? avgSessionLength + ' ×“×§×³' : '-'}</td>
                        <td>${favTool}</td>
                        <td>${stats.quizCount}</td>
                        <td>${avgScore !== '-' ? `<span class="score-badge ${getScoreBadgeClass(avgScore)}">${avgScore}%</span>` : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getDeviceIcon(deviceType) {
            const icons = {
                'mobile': 'ğŸ“±',
                'tablet': 'ğŸ“±',
                'desktop': 'ğŸ’»'
            };
            return icons[deviceType] || 'â“';
        }

        async function loadDifficultQuestions() {
            const rawAttempts = await supabaseGet('question_attempts?select=*');
            const attempts = filterExcluded(rawAttempts);

            if (attempts.length === 0) {
                document.getElementById('difficult-questions-list').innerHTML = '<tr><td colspan="5" class="empty-state">××™×Ÿ × ×ª×•× ×™× ×¢×œ ×©××œ×•×ª ×¢×“×™×™×Ÿ</td></tr>';
                return;
            }

            // Group by question_id - filter only sample test questions
            const stats = {};
            attempts.filter(a => a.quiz_type === 'sample').forEach(a => {
                if (!stats[a.question_id]) {
                    stats[a.question_id] = {
                        text: a.question_text,
                        lesson: a.lesson,
                        quizType: a.quiz_type,
                        total: 0,
                        wrong: 0
                    };
                }
                stats[a.question_id].total++;
                if (!a.is_correct) stats[a.question_id].wrong++;
            });

            // Sort by error rate, filter minimum attempts, top 10
            const hardest = Object.entries(stats)
                .map(([id, d]) => ({ id, ...d, errorRate: (d.wrong / d.total) * 100 }))
                .filter(q => q.total >= 3)
                .sort((a, b) => b.errorRate - a.errorRate)
                .slice(0, 10);

            if (hardest.length === 0) {
                document.getElementById('difficult-questions-list').innerHTML = '<tr><td colspan="5" class="empty-state">×¦×¨×™×š ×™×•×ª×¨ × ×ª×•× ×™× (××™× ×™××•× 3 × ×™×¡×™×•× ×•×ª ×œ×©××œ×”)</td></tr>';
                return;
            }

            document.getElementById('difficult-questions-list').innerHTML = hardest.map(q => `
                <tr>
                    <td title="${q.text || ''}">${(q.text || 'N/A').substring(0, 50)}${(q.text || '').length > 50 ? '...' : ''}</td>
                    <td><span class="quiz-type-badge quiz-type-badge--${q.quizType || 'unknown'}">${getQuizTypeLabel(q.quizType)}</span></td>
                    <td>${q.lesson || '-'}</td>
                    <td>${q.total}</td>
                    <td><span class="score-badge ${q.errorRate > 50 ? 'score-badge--low' : 'score-badge--medium'}">${Math.round(q.errorRate)}%</span></td>
                </tr>
            `).join('');
        }

        function loadScoresList(quizEvents) {
            if (quizEvents.length === 0) {
                document.getElementById('scores-list').innerHTML = '<tr><td colspan="6" class="empty-state">××™×Ÿ ×ª×•×¦××•×ª ××‘×—× ×™× ×¢×“×™×™×Ÿ</td></tr>';
                return;
            }

            document.getElementById('scores-list').innerHTML = quizEvents.map(event => {
                const data = event.event_data || {};
                const percentage = data.percentage || 0;
                const userName = event.users?.display_name || event.users?.animal_name || '×œ× ×™×“×•×¢';

                return `
                    <tr>
                        <td>${formatDate(event.created_at)}</td>
                        <td><strong>${userName}</strong></td>
                        <td><span class="quiz-type-badge quiz-type-badge--${data.quiz_type || 'unknown'}">${getQuizTypeLabel(data.quiz_type)}</span></td>
                        <td>${data.lesson || '-'}</td>
                        <td>${data.score || 0}/${data.total || 0}</td>
                        <td><span class="score-badge ${getScoreBadgeClass(percentage)}">${percentage}%</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Load data on page load - first detect admin device, then load data
        (async function() {
            await initExcludedUsers();
            loadAllData();
        })();

        // Auto-refresh every 30 seconds
        setInterval(loadAllData, 30000);
    </script>
</body>
</html>
